#!/bin/sh

. buildsys/functions

ProcessArgs $*
Assert LoadConfigs
Assert SetupLogDir
Assert SetupResFile

BASE=`/bin/pwd`
CURRENT_PL_LINUX=`uname | grep Linux`
CURRENT_PL_CYGWIN=`uname | grep CYGWIN`
CURRENT_PL_AIX=`uname | grep AIX`
CURRENT_PL_SUNOS=`uname | grep SunOS`
IS_WINDOWS_EXE="false"
DO_DBMSCONNECT="false"
AWK=""

if [ "$CURRENT_PL_SUNOS" != "" ] ;then
   AWK="/usr/xpg4/bin/awk"
else
   AWK="awk"
fi

IS_64_BIT="` $AWK -v a=$SETUP_TYPE 'BEGIN { print index(a, "x86_64") }'`"

IS_STUDIO12="` $AWK -v a=$SETUP_TYPE 'BEGIN { print index(a, "studio12") }'`"

IS_DEBUG="` $AWK -v a=$SETUP_TYPE 'BEGIN { print index(a, "-dev") }'`"

cd ../../..

SetState BuildingExamples
echo "BUILD/EXAMPLES=RUNNING" >> $RESFILE
ArchiveLogs

check_platform()
{

  if [ "$CURRENT_PL_LINUX" != "" -o "$CURRENT_PL_AIX" != "" -o "$CURRENT_PL_SUNOS" != "" ] ;then
    return 0
  elif [ "$CURRENT_PL_CYGWIN" != "" ];then
    return 1
  else
   echo UNKNOWN Platform:
   echo Current platform: `uname`
   exit
  fi
}

if [ "$SETUP_TYPE" = "pcx86.int509-dev" -o "$SETUP_TYPE" = "pcx86.int509-release" ]
then
   if [ "$DEP" != "none" ]
   then
      OSPL_HOME=$DEPWORKDIR
      export OSPL_HOME
   fi

   SPLICE_PLATFORM=$SETUP_TYPE
   export SPLICE_PLATFORM
   . ./configure -full
   SPLICE_ORB=DDS_OpenFusion_1_6_1
   export SPLICE_ORB

   if [ "$CONFIGURATION" != "OK" ]
   then
      echo  "ERROR: configuration - dcps_build_examples"
      exit 1
   fi

   ArchiveLogs

    . $CONFIGFILE
   cd $LOGDIR/examples/build

   $OSPL_OUTER_HOME/testsuite/bin/build_examples_pcx86_integrity509
   exit $?
else

    # Install a copy
    if [ "$DEP" = "none" ]
    then
        INSTALLERDIR=$WORKDIR/build/install
        TEST_SRC_DIR=$WORKDIR/build/testsuite/tests
        . $WORKDIR/build/release_info/RELEASE
        LICENSE_FILE=""
    else
        echo "Setting OUTER_BASE to $BASE..."
        OUTER_BASE=$BASE
        LICENSE_FILE=$OUTER_BASE/../../../etc/license.lic
        BASE=$DEPWORKDIR/build/scripts/overnight
        INSTALLERDIR=$DEPWORKDIR/install
        TEST_SRC_DIR=$DEPWORKDIR/testsuite/tests
        . $DEPWORKDIR/release_info/RELEASE
    fi

    echo "Installing..."

    SHORTSETUP=`echo $SETUP_TYPE | sed 's/-release//'`
    if [ -f $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.bin ]
    then
       echo "Installing $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.bin into $WORKDIR/installed/"

       $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.bin --mode unattended --prefix $WORKDIR/installed/
#--providedLicenseFile licfile
    else
        echo "$INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.bin does not exist"

        if [ -f $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.tar ]
        then
            echo "Untarring $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.tar ..."
            mkdir $WORKDIR/installed
            (
              cd $WORKDIR/installed/ && \
              tar -xvf $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.tar
              mv HDE/$SHORTSETUP/release.com \
                  HDE/$SHORTSETUP/release.com.orig
              sed < HDE/$SHORTSETUP/release.com.orig \
                  > HDE/$SHORTSETUP/release.com \
                  "s%@@INSTALLDIR@@%$WORKDIR/installed/%"
            )
        else

            if [ -f $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.zip ]
            then
                echo "Unzipping $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.zip ..."
                mkdir $WORKDIR/installed
                (
                  cd $WORKDIR/installed/ && \
                  unzip $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE.zip
                )
            else
                if [ -f $INSTALLERDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.exe ]
                then
                  IS_WINDOWS_EXE="true"
                  mkdir $WORKDIR/installed

                  PATH="$PATH:/cygdrive/c/WINDOWS/system32"
                  export PATH

                  XPATH_INSTALLDIR=`cygpath -w "$INSTALLERDIR"`
                  XPATH_WORKDIR=`cygpath -w "$WORKDIR"`

                  echo "exe file exists installing to $WORKDIR/installed ...."
                  cmd.exe /C $XPATH_INSTALLDIR/VC/OpenSpliceDDS$PACKAGE_VERSION-$SHORTSETUP-HDE-installer.exe --mode unattended --prefix $XPATH_WORKDIR/installed/
                fi
            fi
        fi
    fi

    echo "Copying (1) $BASE/example_automation_scripts/* $WORKDIR/installed/HDE/$SHORTSETUP/ ...."
    cp -rp $BASE/example_automation_scripts/* $WORKDIR/installed/HDE/$SHORTSETUP/

    if [ -n "$LICENSE_FILE" ]
    then
        echo "Copying License into $WORKDIR/installed/HDE/$SHORTSETUP/etc ...."
        cp $LICENSE_FILE $WORKDIR/installed/HDE/$SHORTSETUP/etc/.
    fi

    echo "DEP is $DEP....."

    if [ "$DEP" != "none" ]
    then
        echo "Copying (2) $WORKDIR/build/build/scripts/overnight/example_automation_scripts/* $WORKDIR/installed/HDE/$SHORTSETUP/ ...."
        cp -rp $WORKDIR/build/build/scripts/overnight/example_automation_scripts/* $WORKDIR/installed/HDE/$SHORTSETUP/
    fi

    if [ $? = 0 ]
    then
        echo "Install completed"
    else
        echo "ERROR: Install failed"
        exit 1
    fi

    cd $WORKDIR/installed/HDE/$SHORTSETUP/

    if check_platform
    then
        . ./release.com
    fi

    cd examples
    if [ $? != 0 ]
    then
        echo "ERROR: Couldn't locate examples direcctory in installed HDE."
        exit 1
    fi

    # Do not do CORBA C++ and standalone C++ examples with AIX for now as the build fails
    if [ "$CURRENT_PL_AIX" != "" ]
    then
        EXAMPLES="dcps/CORBA/Java/JacORB/PingPong dcps/CORBA/Java/JacORB/Tutorial dcps/standalone/C/PingPong dcps/standalone/C/Tutorial dcps/standalone/C++OnC/PingPong dcps/standalone/Java/PingPong dcps/standalone/Java/Tutorial "
    else
        EXAMPLES="dcps/CORBA/Java/JacORB/PingPong dcps/CORBA/Java/JacORB/Tutorial dcps/CORBA/C++/OpenFusion/PingPong dcps/CORBA/C++/OpenFusion/Tutorial dcps/standalone/C/PingPong dcps/standalone/C/Tutorial dcps/standalone/C++/PingPong dcps/standalone/C++/Tutorial dcps/standalone/C++OnC/PingPong dcps/standalone/Java/PingPong dcps/standalone/Java/Tutorial "

        # DLRL and dbmsconnect examples are not included in an inner only build so only add them if doing an outer build
        if [ "$DEP" != "none" ]
        then
            EXAMPLES=$EXAMPLES" dlrl/standalone/Java/Tutorial dlrl/standalone/C++/Tutorial "

            # If it's windows don't build the dbmsconnect example and do not add for 64 bit linux either - see dds1869
            # Do not do it if it's studio12 either because the ODBC for that is installed in the wrong place and the
            # odbc.ini and odbc.inst files are not populated.
            if [ "$IS_WINDOWS_EXE" = "false" -a "$IS_64_BIT" = "0" -a "$IS_STUDIO12" = "0" ]
            then
                EXAMPLES=$EXAMPLES" services/dbmsconnect/SQL/C++/ODBC "
            fi
        fi
    fi

    export EXAMPLES

    export TEST_SRC_DIR

    #These examples have special files for build: BUILD(or BUILD.bat for Windows)
    SPECIAL_BUILD_FILES="dcps/CORBA/Java/JacORB/PingPong dcps/CORBA/Java/JacORB/Tutorial dcps/standalone/Java/PingPong dcps/standalone/Java/Tutorial dlrl/standalone/Java/Tutorial dlrl/standalone/C++/Tutorial "

    # services/dbmsconnect/SQL/C++/ODBC " - this should use a BUILD file but that doesn't work at the minute - see dds1869
    export SPECIAL_BUILD_FILES

    if [ "$CURRENT_PL_AIX" != "" ]
    then
       PATH="/usr/vac/bin:/usr/vacpp/bin:$PATH"
    fi

    echo "Build Examples:"
    if check_platform
    then
        PATH="$JAVA_HOME/bin:$PATH"
        PATH="$PATH:$TAO_ROOT/bin:$JACORB_HOME/bin"

        LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$TAO_ROOT/lib"

        SPLICE_ORB=DDS_OpenFusion_1_6_1

        CLASSPATH="$CLASSPATH:$JACORB_HOME/lib/endorsed/jacorb.jar:$JACORB_HOME/lib/endorsed/logkit.jar:$JACORB_HOME/lib/idl.jar"
        ACE_ROOT=$TAO_ROOT

        export PATH LD_LIBRARY_PATH SPLICE_ORB CLASSPATH ACE_ROOT

        ODBCINI="$ODBCHOME/etc/odbc.ini"
        ODBCINST="$ODBCHOME/etc/odbcinst.ini"
        ODBC_MSSQL_SERVER="10.1.0.189"
        ODBC_MYSQL_SERVER="10.1.0.191"
        ODBCSYSINI="$ODBCHOME/etc"

        export  ODBCINI ODBCINST ODBC_MSSQL_SERVER ODBC_MYSQL_SERVER ODBCSYSINI

        sh $BASE/build_examples.sh
    else
        PATH="$PATH:/cygdrive/c/WINDOWS/system32"
        export PATH

        # Hey look it's a comment !
        # If the version of VStudio is not VCpp 8 regenerate the test build files for VCpp 9
        if [ "$VS_VER" != "14" ]
        then
            pushd $TEST_SRC_DIR
            ACE_ROOT=$TAO_ROOT
            export ACE_ROOT
            MPC_ROOT=$TAO_ROOT/MPC
            echo "Regenerating Visual Studio test buildfiles."
            PATH="$PATH:$TAO_ROOT/bin"
            mwc.pl -type vc9 -include ../../MPC/config -noreldefs
            popd
        fi

        XPATH=`cygpath -w "$WORKDIR/installed/HDE/$SHORTSETUP"`

        echo "set OSPL_HOME=$XPATH" > setenv.bat

        XPATH=`cygpath -d "$TAO_ROOT"`
        echo "set TAO_ROOT=$XPATH" >> setenv.bat
        echo "set ACE_ROOT=$XPATH" >> setenv.bat
        echo "set VS_VER=$VS_VER" >> setenv.bat

        BUILD_CONFIG="DEBUG"

        if [ "$IS_DEBUG" = "0" ]
        then
            BUILD_CONFIG="RELEASE"
        fi

        echo "set BUILD_CONFIG=$BUILD_CONFIG" >> setenv.bat

        XPATH=`cygpath -w "$JACORB_HOME"`
        echo "set JACORB_HOME=$XPATH" >> setenv.bat

        XPATH=`cygpath -w "$LOGDIR"`
        echo "set LOGDIR=$XPATH" >> setenv.bat

        echo "set SPLICE_ORB=DDS_OpenFusion_1_6_1" >> setenv.bat

        echo "set JAVA_HOME=$JAVA_HOME" >> setenv.bat

        echo "set PATH=%JAVA_HOME%\bin;%TAO_ROOT%\bin;%TAO_ROOT%\lib;%PATH%;%JACORB_HOME%\bin" >> setenv.bat

        echo "set CLASSPATH=%CLASSPATH%;%JACORB_HOME%\lib\endorsed\jacorb.jar;%JACORB_HOME%\lib\endorsed\logkit.jar;%JACORB_HOME%\lib\idl.jar" >> setenv.bat

        echo "set VS_ENV_SCRIPT=$VS_ENV_SCRIPT" >> setenv.bat

        XPATH=`cygpath -w "$BASE"`

        # For some reason dds3-win2k3 likes uppercase C - this works on
        # the other windows machines too
        cmd.exe /C $XPATH/build_examples.bat

    fi
    exit $?
fi
